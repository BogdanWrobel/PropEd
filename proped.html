<!doctype html>
<html lang="en">
    <head>
        <title>PropEd</title>
        <meta charset="utf-8">
        <link rel="shortcut icon" type="image/jpg" href="data:image"/>
        <link href="data:image/x-icon;base64,AAABAAEAICAAAAEAIACoEAAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAuLi4WMjIykzIyMuMyMjL9MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8yMjL3MjIyxjExMVcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMDAwJTIyMuUzMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zExMZUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEyMjLMMzMz/zIyMv4zMzOvMzMzeDIyMnUyMjJ1MjIydTIyMnUyMjJ1MjIydTIyMnUyMjJ1MjIyhDIyMtozMzP/MzMz/zExMVcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMzMzPDMzM/8zMzP/MjIyfv///////////////////////////////////////////////////////////////zMzM74zMzP/MjIyxgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAxMTFtMzMz/zMzM///////////////////////////////////////////////////////////////////////MjIydTMzM/8yMjL3AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADIyMnUzMzP/MzMz//////////////////////////////////////////////////////////////////////8yMjJ1MzMz/zMzM/8AAAAAAAAAADIyMjMyMjKeMjIy0DMzM9czMzPXMzMz1zMzM9czMzPXMzMz1zMzM9czMzPXMjIy6DIyMv0yMjL+////////////////////////////////+Pj4pi4uLib//////////////////////////zIyMnUzMzP/MzMz/wAAAAAzMzNuMjIy/DMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzPN/////////////////////zAwMEUyMjLqMDAwSf//////////////////////////MjIydTMzM/8zMzP/MzMzQTIyMv0zMzP/MjIy9DIyMqwyMjKcMjIynDIyMpwyMjKcMjIynDIyMpwyMjKcMjIynDExMZ8yMjLQMzMz/zMzM/8yMjK2//////////8yMjJ/MjIy/DMzM/8wMDBJ//////////////////////////8yMjJ1MzMz/zMzM/8zMzO5MzMz/zIyMu0uLi4m//////////////////////////////////////////////////////////8yMjJ1MzMz/zMzM/4wMDBEMTExuDMzM/8zMzP/MzMz/zIyMmUtLS0nLS0tJy4uLib//////////zIyMnUzMzP/MzMz/zIyMvMzMzP/MjIyjf////////////////////////////////////////////////////////////////////8zMzP/MzMz/zIyMvszMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz+v//////////MjIydTMzM/8zMzP/MjIy/jMzM/8xMTF2/////////////////////////////////////////////////////////////////////zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP6//////////8yMjJ1MzMz/zMzM/8zMzP/MzMz/zMzM3j//////////////////////////zExMST/////////////////////////////////////MzMz/zMzM/8yMjKeMjIy1TMzM/8zMzP/MzMz/zExMYExMTFOMTExTjExMU3//////////zIyMnUzMzP/MzMz/zMzM/8zMzP/MjIyev//////////////////////////MjIyeTExMbj///////////////////////////////8zMzP/MzMz/zIyMnX/////MjIypjMzM/8zMzP/MDAwSf//////////////////////////MjIydTMzM/8zMzP/MzMz/zMzM/8zMzN9//////////////////////////8yMjJ5MzMz/zIyMuIyMjI4/////////////////////zMzM/8zMzP/MjIydf//////////MjIyajIyMvgwMDBJ//////////////////////////8yMjJ1MzMz/zMzM/8zMzP/MzMz/zIyMn///////////////////////////zIyMnkzMzP/MzMz/zIyMvkzMzNu////////////////MzMz/zMzM/8yMjJ1////////////////MDAwNTMzMzL//////////////////////////zIyMnUzMzP/MzMz/zMzM/8zMzP/MTExgf////8vLy8rMzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzOq//////////8zMzP/MzMz/zIyMnX/////////////////////////////////////////////////////MjIydTMzM/8zMzP/MzMz/zMzM/8yMjKD/////y8vLyszMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zIyMvQzMzNL/////zMzM/8zMzP/MjIydf////////////////////////////////////////////////////8zMzOCMzMz/zIyMvczMzP/MzMz/zExMYX//////////zIyMnUyMjJ1MjIydTIyMrczMzP/MzMz/zMzM/8zMzPXLy8vK///////////MzMz/zMzM/8yMjJ1////////////////////////////////MTExcTIyMokyMjKJMTExlDMzM/AzMzP/MTExpDMzM/8zMzP/MjIyiP//////////////////////////MjIyeTMzM/8zMzP/MjIyqP////////////////////8zMzP/MzMz/zIyMnX//////////////////////////zMzM1UzMzP/MzMz/zMzM/8zMzP/MzMz/zIyMs4kJCQOMzMz/zMzM/8xMTGK//////////////////////////8yMjJ5MjIy+DExMWz//////////////////////////zMzM/8zMzP/MjIydf//////////////////////////MTExYTMzM/8zMzP/MzMz/zMzM/8zMzPNKioqEgAAAAAzMzP/MzMz/zMzM4z//////////////////////////zExMVwvLy82////////////////////////////////MzMz/zMzM/8yMjJ1//////////////////////////8xMTFhMzMz/zMzM/8zMzP/MjIyyi0tLREAAAAAAAAAADMzM/8zMzP/MjIyjv////////////////////////////////////////////////////////////////////8zMzP/MzMz/zIyMnX//////////////////////////zExMYAzMzP/MzMz/zIyMssvLy8QAAAAAAAAAAAAAAAAMzMz/zMzM/8xMTGQ/////////////////////////////////////////////////////////////////////zMzM/8zMzP/MzMzyDIyMpwyMjKcMjIynDIyMpwyMjKrMjIy+TMzM/8zMzPNLS0tEQAAAAAAAAAAAAAAAAAAAAAzMzP/MzMz/zIyMpP///////////////////////////////////////////Dw8IAyMjJgMTExYjAwMGMyMjKiMzMz/zIyMv4yMjL8MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMzzSgoKBMAAAAAAAAAAAAAAAAAAAAAAAAAADMzM/8zMzP/MTExlf//////////////////////////////////////////MjIy0zMzM/8zMzP/MzMz/zMzM/8zMzP/MjIyxjIyMtUzMzPXMzMz1zMzM9czMzPXMjIy0zMzM5EqKioMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMzMz/zMzM/8yMjKX//////////////////////////////////////////8zMzPrMzMz/zMzM/8zMzP/MjIy/jIyMn4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAyMjL3MzMz/zExMZr//////////////////////////////////////////zMzM+szMzP/MzMz/zIyMv4yMjJ6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADIyMsUzMzP/MjIy4v//////////////////////////////////////////MjIy9jMzM/8yMjL+MzMzeAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMTExVzMzM/8zMzP/MzMz4TIyMoQyMjJ1MjIydTIyMnUyMjJ0MTExdjIyMrwzMzP/MzMz/zExMXwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMTExlDMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zMzM/8zMzP/MzMz/zIyMv4yMjJ/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMTExVzIyMsUyMjL3MzMz/zMzM/8zMzP/MzMz/zIyMv4yMjLlMDAwYwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//4AA//8AAH/+AAA//gAAP/4AAD/+AAAwAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAwAAAAcAAAAPAAAAHwAAAD8AAH//AAD//wAB//8AA///gAf//8AP//8=" rel="icon" type="image/x-icon" />
        <style>
            table#entries {
                width: 100%;
            }
            table.hideSame#entries tr.same {
                display: none;
            }
            table.hideNew#entries tr.new {
                display: none;
            }
            table.hideDifferent#entries tr.different {
                display: none;
            }

            table#entries {
                margin-top: 3.3em;
                table-layout: fixed;
            }

            tr {
                transition-property: background-color;
                transition-duration: .1s;
            }

            tr.skip {
                opacity: .3;
            }

            tr.same td {
                /* color: #4caf50; */
                color: #aaa;
            }
            tr.different td {
                color: #f44336;
            }
            tr.new td {
                /* color: #2196f3; */
                color: #4caf50;
            }
            tbody tr:hover th, tbody tr:hover td {
                background-color: #fffce1;
            }

            tbody tr:hover td:hover {
                background-color: #fff6a4  !important;
            }

            tbody th {
                cursor: default;
            }

            th {
                background-color: #eeeeee;
                font-weight: normal;
                border-radius: .4em;
                padding: .4em 0;
                word-wrap: break-word;
            }

            td.propval {
                cursor: pointer;
                word-wrap: break-word;
                border-radius: .4em;
                padding: .4em .2em;
            }
            td.propval:hover {
                /* text-decoration: underline; */
            }
            .hidden {
                display: none !important;
            }
            #downloadLink {
                display: none;
            }
            body {
                font-family: Arial, Helvetica, sans-serif;
                font-size: 10pt;
            }
            #toolbar {
                position: fixed;
                top: 0;
                height: auto;
                width: 100%;
                background-color: white;
                padding: .2em;
                left: -5px;
                box-shadow: 0 0 5px #000;
            }

            #toolbar button, #toolbar input[type="file"] {
                padding: .4em;
                border-radius: .4em;
                border: 1px solid #cccccc;
                cursor: pointer;
            }

            #toolbar button:hover, #toolbar input[type="file"]:hover {
                background-color: #e0e0e0;
            }

            .finalValue  {
                color: #999999 !important;
            }

            .finalValue > input {
                width: calc(100% - 6em);
                padding: .4em;
                border-radius: .4em;
                border: 1px solid #cccccc;
            }

            .finalValue > input:focus {
                box-shadow: inset 0 0 5px #ddd;
            }

            .finalValue label {
                width: 5em;
                display: inline-block;
                cursor: pointer;
            }

            .finalValue label:hover {
                color: #222222;
            }

            .finalValue label input {
                cursor: pointer;
            }

            #filters label, #filters label input {
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div id="toolbar">
            <input type="file" id="first">
            <input type="file" id="second">
            <button id="action" disabled="disabled">Load files</button>
            <button id="downloadButton" disabled="disabled">Download</button>
            <a id="downloadLink" download="local.properties">test</a>    
        </div>
        <table id="entries">
            <thead>
                <tr><th colspan="4" id="filters">
                    show: 
                    <label><input type="checkbox" checked="checked" id="showEqual" data-filter="Same">equal</label>
                    <label><input type="checkbox" checked="checked" id="showDifferent" data-filter="Different">different</label>
                    <label><input type="checkbox" checked="checked" id="showNew" data-filter="New">new</label>
                </th></tr>
                <tr><th>key</th><th class="firstFileName">first</th><th class="secondFileName">second</th><th>final</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="4">Pick two .properties files to compare.</td></tr>
            </tbody>
            <tfoot>
                <tr><th>key</th><th class="firstFileName">first</th><th class="secondFileName">second</th><th>final</th></tr>
            </tfoot>
        </table>
        <script>
            const first = document.getElementById('first');
            const second = document.getElementById('second');
            const actionButton = document.getElementById('action');
            const table = document.getElementById('entries');
            const downloadButton = document.getElementById('downloadButton');
            const downloadLink = document.getElementById('downloadLink');

            // handle filter clicks
            document.querySelectorAll('#filters input[type="checkbox"]').forEach((item) => {
                item.addEventListener('change', () => {
                    table.classList.toggle(`hide${item.dataset.filter}`, !item.checked);
                })
            });

            // handle load files action
            actionButton.addEventListener('click', loadFiles);
            // handle download button
            downloadButton.addEventListener('click', collectEntries);
            // auto-load properties
            [first, second].forEach((item) => {
                item.addEventListener('change', (obj) => {
                    actionButton.disabled = (first.files.length == 0 || second.files.length == 0);
                    if (!actionButton.disabled) {
                        actionButton.click();
                    }
                })
            });

            // create table row
            function createRow(key, value1, value2) {
                const tr = document.createElement('tr');
                tr.id = key;
                tr.classList.add(value1 == value2 ? "same" : ((value1 == "" || value2 == "") ? "new" : "different"));

                const th = document.createElement('th');
                th.textContent = key;
                tr.appendChild(th);
                [value1, value2].forEach(val => {
                    const td = document.createElement('td');
                    td.textContent = val;
                    td.classList.add('propval');
                    td.title = "Select this value";
                    td.addEventListener('click', () => {
                        document.querySelector(`input[name="${key}"]`).value = val;
                    });
                    tr.appendChild(td);
                });

                const td = document.createElement('td');
                td.classList.add('finalValue');
                
                const input = document.createElement('input');
                input.name = key;
                input.type = 'text';
                td.title = `Property: ${key}`;
                td.appendChild(input);

                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                const span = document.createElement('span');
                span.textContent = 'include';
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.addEventListener('change', () => {
                    tr.classList.toggle('skip', !checkbox.checked);
                });
                span.title = "Include in final file"

                label.appendChild(checkbox);
                label.appendChild(span);
                td.appendChild(label);
                tr.appendChild(td);

                if (value1 == "" || value2 == "" || value1 == value2) {
                    input.value = value1 || value2;
                }

                return tr;
            }

            // load both files and create table
            async function loadFiles() {
                actionButton.disabled = true;
                downloadButton.disabled = true;

                const [props1, props2] = await Promise.all([
                    getProperties(first.files[0]),
                    getProperties(second.files[0])
                ]);

                // set table headers
                table.querySelectorAll('.firstFileName').forEach((th) => {
                    th.textContent = first.files[0].name;
                });
                table.querySelectorAll('.secondFileName').forEach((th) => {
                    th.textContent = second.files[0].name;
                });

                const tbody = table.querySelector('tbody');

                // reset filters
                ['hideSame', 'hideNew', 'hideDifferent'].forEach((name) => {
                    table.classList.remove(name);
                });
                document.querySelectorAll('#filters input[type="checkbox"]').forEach((item) => {
                    item.checked = true;
                });

                // remove rows
                while (tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }

                const rows = [];

                for (let key in props1) {
                    if (props2.hasOwnProperty(key)) {
                        rows.push(createRow(key, props1[key], props2[key]));
                        delete props2[key];
                    } else {
                        rows.push(createRow(key, props1[key], ""));
                    }
                }

                for (let key in props2) {
                    rows.push(createRow(key, "", props2[key]));
                }

                rows.sort((first, second) => {
                    return first.id.toUpperCase() === second.id.toUpperCase() ? 0 : (first.id > second.id ? 1 : -1);
                });

                rows.forEach(row => {
                    tbody.appendChild(row);
                });

                downloadButton.disabled = false;
                actionButton.disabled = false;
            }

            function collectEntries() {
                let totalEmpty = 0;
                table.querySelectorAll('tr.different').forEach((row) => {
                    if (row.querySelector('.finalValue input[type="text"]').value == "" && row.querySelector('.finalValue input[type="checkbox"]').checked) {
                        totalEmpty++;
                    }
                });
                if (totalEmpty == 0 || confirm(`There are ${totalEmpty} conflicting entries selected for saving with no value. Continue?`)) {
                    let entries = table.querySelectorAll('.finalValue');
                    let blobData = "";
                    entries.forEach(entry => {
                        if (entry.querySelector('input[type="checkbox"]:checked')) {
                            let val = entry.querySelector('input[type="text"]');
                            blobData += val.name + "=" + val.value + "\n";
                        }
                    });
                    let blob = new Blob([blobData], {type: 'application/binary'});
                    let url = window.URL.createObjectURL(blob);
                    
                    downloadLink.href = url;
                    downloadLink.click();
                    window.URL.revokeObjectURL(url);
                }
                return false;
            }

            function lineMatches(line) {
                return line != "" && !line.match(/^#/) && line.match(/=/);
            }

            function loadFile(file) {
                return new Promise((resolve) => {
                    console.debug(`Loading '${file.name}'...`);
                    let fileReader = new FileReader();
                    fileReader.onload = (e) => resolve(fileReader.result, file.name);
                    fileReader.readAsText(file);
                });
            }

            function splitContents(raw, fileName) {
                return new Promise((resolve) => {
                    console.debug(`Splitting raw data for '${fileName}'...`);
                    let lines = raw.split('\n');
                    let result = {};
                    lines.forEach(line => {
                        if (lineMatches(line)) {
                            let index = line.indexOf("=");
                            let key = line.substr(0, index).trim();
                            let value = line.substr(index + 1).trim();
                            if (result.hasOwnProperty(key)) {
                                console.warn(`Duplicate value found in '${fileName}' for '${key}': '${result[key]}' => '${value}'.`);
                            } 
                            result[key] = value;
                            
                        }
                    });
                    resolve(result);
                });
            }

            async function getProperties(file) {
                let res = await loadFile(file)
                let props = await splitContents(res, file.name);
                return props;
            }
        </script>

    </body>
</html>